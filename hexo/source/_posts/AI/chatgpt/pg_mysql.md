
OLTPã€OLAPã€MVCCã€è¡Œçº§é”ã€é—´éš™é”ã€ASTã€CTEï¼ˆWITHï¼‰ã€LATERAL JOINã€çª—å£å‡½æ•°ã€ARRAYã€GISï¼ˆPostGISï¼‰
# ä¸€ã€å…ˆç»™ä½ ä¸€å¼ â€œåœ°å›¾â€ï¼ˆå¾ˆé‡è¦ï¼‰

```
ä¸šåŠ¡åœºæ™¯å±‚
 â”œâ”€ OLTP / OLAP

æ•°æ®åº“å†…æ ¸å±‚
 â”œâ”€ MVCC
 â”œâ”€ è¡Œçº§é” / é—´éš™é”

SQL è§£æž & æ‰§è¡Œå±‚
 â”œâ”€ AST
 â”œâ”€ CTEï¼ˆWITHï¼‰
 â”œâ”€ LATERAL JOIN
 â”œâ”€ çª—å£å‡½æ•°

æ•°æ®ç±»åž‹ & æ‰©å±•èƒ½åŠ›å±‚
 â”œâ”€ ARRAY
 â”œâ”€ GISï¼ˆPostGISï¼‰
```

ðŸ‘‰ **ä½ çŽ°åœ¨åšçš„æ˜¯ï¼š**

* æ•°æ®æƒé™
* å¤šæ•°æ®åº“
* SQL æ‹¦æˆª & æ”¹å†™

æ‰€ä»¥**å‡ ä¹Žæ¯ä¸€å±‚éƒ½ä¼šè¸©å‘**ã€‚

---

# äºŒã€ä¸šåŠ¡åœºæ™¯å±‚ï¼ˆå…ˆæžæ¸…â€œæ•°æ®åº“åœ¨å¹²å˜›â€ï¼‰

## 1ï¸âƒ£ OLTP æ˜¯ä»€ä¹ˆï¼Ÿ

**Online Transaction Processing**

ðŸ‘‰ **â€œæ—¥å¸¸ä¸šåŠ¡ç³»ç»Ÿâ€**

ç‰¹å¾ï¼š

* æŸ¥è¯¢ç®€å•
* äº‹åŠ¡çŸ­
* å¹¶å‘é«˜
* å†™å¾ˆå¤š

ä¾‹å­ï¼š

```text
ä¸‹å•
ä»˜æ¬¾
æ”¹çŠ¶æ€
æŸ¥åˆ—è¡¨
```

å…¸åž‹ SQLï¼š

```sql
SELECT * FROM order WHERE user_id = ? LIMIT 10;
```

ðŸ“Œ **ä½ çŽ°åœ¨çš„ç³»ç»Ÿ 90% æ˜¯ OLTP**

---

## 2ï¸âƒ£ OLAP æ˜¯ä»€ä¹ˆï¼Ÿ

**Online Analytical Processing**

ðŸ‘‰ **â€œåˆ†æž / æŠ¥è¡¨ / ç»Ÿè®¡â€**

ç‰¹å¾ï¼š

* SQL å¾ˆå¤æ‚
* æ‰«å¤§é‡æ•°æ®
* èšåˆå¤š
* æ…¢ä¸€ç‚¹æ²¡å…³ç³»

ä¾‹å­ï¼š

```sql
ç»Ÿè®¡è¿‡åŽ»ä¸€å¹´æ¯ä¸ªéƒ¨é—¨çš„å®¡æ‰¹å¹³å‡æ—¶é•¿
```

```sql
SELECT dept_id, AVG(cost_time)
FROM approval
GROUP BY dept_id;
```

ðŸ“Œ **ä¸€æ—¦ä½ æŠŠâ€œä¸šåŠ¡é€»è¾‘å¡žè¿› SQLâ€ï¼Œä½ å°±å¼€å§‹ç¢° OLAP èƒ½åŠ›äº†**

---

# ä¸‰ã€æ•°æ®åº“å†…æ ¸å±‚ï¼ˆä¸ºä»€ä¹ˆä¼šé”ã€æ­»é”ã€åˆ†é¡µæ€ªï¼‰

## 3ï¸âƒ£ MVCC æ˜¯ä»€ä¹ˆï¼Ÿ

**Multi-Version Concurrency Control**

ðŸ‘‰ **â€œåŒä¸€è¡Œæ•°æ®ï¼Œæœ‰å¤šä¸ªç‰ˆæœ¬â€**

### ä¸ç”¨ MVCC ä¼šæ€Žæ ·ï¼Ÿ

* è¯»è¦ç­‰å†™
* å†™è¦ç­‰è¯»
* å¹¶å‘æžå·®

### æœ‰ MVCCï¼š

* è¯»æ—§ç‰ˆæœ¬
* å†™æ–°ç‰ˆæœ¬
* äº’ä¸é˜»å¡ž

ðŸ“Œ **ä½ ä¸ºä»€ä¹ˆé‡åˆ°â€œæˆ‘æ˜Žæ˜Žæ›´æ–°äº†ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡è¿˜æŸ¥åˆ°æ—§æ•°æ®â€ï¼Ÿ**
ðŸ‘‰ å°±æ˜¯ MVCC

---

## 4ï¸âƒ£ è¡Œçº§é” æ˜¯ä»€ä¹ˆï¼Ÿ

ðŸ‘‰ **â€œåªé”è¿™ä¸€è¡Œï¼Œä¸é”æ•´å¼ è¡¨â€**

```sql
UPDATE user SET name = 'A' WHERE id = 1;
```

é”çš„åªæ˜¯ `id = 1` é‚£ä¸€è¡Œã€‚

ðŸ“Œ è¡Œçº§é”æ˜¯å¥½ä¸œè¥¿ï¼Œ**å¹¶å‘é«˜**ã€‚

---

## 5ï¸âƒ£ é—´éš™é” æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆMySQL ç‰¹æœ‰çš„å‘ï¼‰

ðŸ‘‰ **â€œé”ä½ä¸€æ®µâ€˜ä¸å­˜åœ¨çš„åŒºé—´â€™â€**

```sql
SELECT * FROM order WHERE id > 10 AND id < 20 FOR UPDATE;
```

å³ä½¿ `id=15` ä¸å­˜åœ¨ï¼Œ
**MySQL ä¹Ÿä¼šæŠŠ 10~20 è¿™æ®µâ€œç©ºéš™â€é”ä½**ã€‚

ðŸ“Œ ç”¨æ¥é˜²æ­¢â€œå¹»è¯»â€
ðŸ“Œ ä¹Ÿæ˜¯æ­»é”åˆ¶é€ æœº

ðŸ‘‰ **PG æ²¡æœ‰é—´éš™é”**

---

# å››ã€SQL è§£æž & æ‰§è¡Œå±‚ï¼ˆä½ æ‹¦æˆª SQL å°±åœ¨è¿™é‡Œï¼‰

## 6ï¸âƒ£ AST æ˜¯ä»€ä¹ˆï¼Ÿ

**Abstract Syntax Treeï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰**

ðŸ‘‰ **SQL çš„â€œè¯­æ³•ç»“æž„æ ‘â€**

```sql
SELECT * FROM user WHERE id = 1;
```

åœ¨æ•°æ®åº“/è§£æžå™¨çœ¼é‡Œæ˜¯ï¼š

```
SELECT
 â”œâ”€ columns: *
 â”œâ”€ FROM: user
 â””â”€ WHERE
     â””â”€ id = 1
```

ðŸ“Œ **ä½ çŽ°åœ¨ç”¨ JSqlParser æ”¹ SQL**
ðŸ‘‰ æœ¬è´¨å°±æ˜¯åœ¨ **æ”¹ AST**

ðŸ‘‰ ä½ çŽ°åœ¨ SQLâ€œé”™ä¹±â€ï¼Œå°±æ˜¯ **å­—ç¬¦ä¸²æ”¹äº† AST å´ä¸å¯¹**

---

## 7ï¸âƒ£ CTEï¼ˆWITHï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ

ðŸ‘‰ **â€œç»™å¤æ‚ SQL èµ·ä¸€ä¸ªä¸´æ—¶åå­—â€**

```sql
WITH dept_user AS (
  SELECT * FROM user WHERE dept_id = 10
)
SELECT * FROM dept_user WHERE status = 1;
```

å¥½å¤„ï¼š

* å¯è¯»æ€§æžå¼º
* å¯å¤ç”¨
* å¯é€’å½’

ðŸ“Œ **æ•°æ®æƒé™ / å¤æ‚æŸ¥è¯¢ éžå¸¸é€‚åˆç”¨ CTE**

---

## 8ï¸âƒ£ LATERAL JOIN æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆPG ç¥žå™¨ï¼‰

ðŸ‘‰ **â€œå­æŸ¥è¯¢å¯ä»¥ç”¨å‰é¢è¡¨çš„å­—æ®µâ€**

```sql
SELECT u.id, o.last_order_time
FROM user u
LEFT JOIN LATERAL (
  SELECT create_time AS last_order_time
  FROM orders
  WHERE orders.user_id = u.id
  ORDER BY create_time DESC
  LIMIT 1
) o ON true;
```

ðŸ“Œ MySQL âŒ
ðŸ“Œ PostgreSQL âœ…

ðŸ‘‰ **æƒé™ / æœ€æ–°è®°å½• / TOP-N éžå¸¸å¥½ç”¨**

---

## 9ï¸âƒ£ çª—å£å‡½æ•° æ˜¯ä»€ä¹ˆï¼Ÿ

ðŸ‘‰ **â€œä¸ GROUP BYï¼Œä¹Ÿèƒ½åšç»Ÿè®¡â€**

```sql
SELECT
  user_id,
  amount,
  SUM(amount) OVER (PARTITION BY user_id) AS total_amount
FROM orders;
```

å¯¹æ¯”ï¼š

* GROUP BYï¼šè¡Œä¼šå˜å°‘
* çª—å£å‡½æ•°ï¼šè¡Œæ•°ä¸å˜

ðŸ“Œ æŠ¥è¡¨ / æŽ’å / ç´¯è®¡ éžå¸¸é‡è¦

---

# äº”ã€æ•°æ®ç±»åž‹ & æ‰©å±•èƒ½åŠ›å±‚

## ðŸ”Ÿ ARRAY æ˜¯ä»€ä¹ˆï¼Ÿ

ðŸ‘‰ **â€œä¸€åˆ—å­˜å¤šä¸ªå€¼â€**

```sql
tags TEXT[];
```

```sql
SELECT * FROM article WHERE 'java' = ANY(tags);
```

ðŸ“Œ MySQL åŸºæœ¬æ²¡æœ‰
ðŸ“Œ PG åŽŸç”Ÿæ”¯æŒ

---

## 1ï¸âƒ£1ï¸âƒ£ GISï¼ˆPostGISï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ

ðŸ‘‰ **â€œæ•°æ®åº“ç›´æŽ¥ç®—åœ°ç†ä½ç½®â€**

```sql
SELECT *
FROM shop
WHERE ST_Distance(location, user_location) < 1000;
```

ç”¨é€”ï¼š

* é™„è¿‘çš„äºº
* æœ€è¿‘çš„åº—
* åœ°å›¾åº”ç”¨

ðŸ“Œ PG + PostGIS æ˜¯è¡Œä¸šæ ‡å‡†

---

# å…­ã€æŠŠè¿™äº›å’Œä½ çŽ°åœ¨çš„é—®é¢˜è¿žèµ·æ¥ï¼ˆé‡ç‚¹ï¼‰

| ä½ çŽ°åœ¨é‡åˆ°çš„ç—›ç‚¹       | æœ¬è´¨              |
| -------------- | --------------- |
| åˆ†é¡µ SQL ä¹±       | AST è¢«ç ´å         |
| æ•°æ®æƒé™å¤æ‚         | éœ€è¦ CTE / å­æŸ¥è¯¢    |
| MySQL / DM ä¸ä¸€è‡´ | å†…æ ¸ & SQL èƒ½åŠ›ä¸åŒ   |
| PageHelper ä¸ç”Ÿæ•ˆ | æ–¹è¨€ + æ‰§è¡Œé¡ºåº       |
| æ­»é” / æ…¢         | è¡Œé” / é—´éš™é” / MVCC |

---

# ä¸ƒã€å­¦ä¹ å»ºè®®ï¼ˆç»™ä½ å·¥ç¨‹å‘çš„ï¼Œä¸èµ°å¼¯è·¯ï¼‰

### å­¦ä¹ é¡ºåºï¼ˆéžå¸¸é‡è¦ï¼‰ï¼š

1ï¸âƒ£ **OLTP vs OLAPï¼ˆå…ˆæƒ³æ¸…æ¥šä¸šåŠ¡ï¼‰**
2ï¸âƒ£ **MVCC / é”ï¼ˆä¸ºä»€ä¹ˆè¡Œä¸ºä¸åŒï¼‰**
3ï¸âƒ£ **AST / SQL æ‰§è¡Œé¡ºåºï¼ˆä½ çŽ°åœ¨å°±åœ¨è¿™ï¼‰**
4ï¸âƒ£ **CTE / çª—å£å‡½æ•°ï¼ˆè§£å¤æ‚ SQLï¼‰**
5ï¸âƒ£ **é«˜çº§ç±»åž‹ï¼ˆæœ‰éœ€è¦å†å­¦ï¼‰**

---

å¦‚æžœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æŽ¥ï¼š

* ðŸ” ç”¨ **ä½ çŽ°åœ¨çš„æ•°æ®æƒé™ SQL**ï¼Œç”»ä¸€æ£µ AST ç»™ä½ çœ‹
* âœ‚ï¸ æ•™ä½  **â€œæ‹¦æˆªå™¨æ”¹ SQL çš„æ­£ç¡®å§¿åŠ¿â€**
* ðŸ§  ç»™ä½ ä¸€å¥— **MySQL / PG / DM é€šç”¨çš„æƒé™åˆ†é¡µæ–¹æ¡ˆ**

ä½ åªè¦è¯´ä¸€å¥ï¼š
ðŸ‘‰ **â€œæˆ‘æœ€å¤´ç–¼çš„æ˜¯åˆ†é¡µï¼Œè¿˜æ˜¯æƒé™ SQLï¼Ÿâ€**
